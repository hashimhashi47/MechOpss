<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Booked Services Dashboard</title>
</head>

<body class="bg-gradient-to-br from-gray-50 to-gray-100 min-h-screen flex">
  <!-- Sidebar -->
  {{ template "sidebar" }}

  <!-- Main Section -->
  <main class="flex-1 px-4 py-8 overflow-auto">

    <!-- Header -->
    <div class="bg-white p-8 rounded-xl mb-8 shadow-sm max-w-7xl mx-auto">
      <div class="flex items-center justify-between mb-4">
        <div>
          <h1 class="text-4xl font-bold text-gray-800 mb-2">ðŸš— Booked Services Dashboard</h1>
          <p class="text-gray-600">Manage and track all service bookings</p>
        </div>

        <div
          class="bg-gradient-to-r from-purple-500 to-purple-700 text-white px-6 py-4 rounded-lg text-center min-w-[120px]">
          <div class="text-3xl font-bold" id="totalCount">0</div>
          <div class="text-sm opacity-90">Total Bookings</div>
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div
      class="max-h-[600px] overflow-x-auto overflow-y-auto rounded-xl shadow-lg bg-white max-w-7xl mx-auto scrollbar-thin scrollbar-thumb-gray-400 scrollbar-track-gray-100">
      <table class="w-full border-separate border-spacing-0" style="min-width: 2000px;">
        <thead class="sticky top-0 z-10 bg-gradient-to-r from-blue-900 to-blue-600">
          <tr>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 140px;">Car Number</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 180px;">Status</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 220px;">Problem</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 200px;">Address</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 280px;">Staff Assignment</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 140px;">Payment</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 140px;">Amount</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 140px;">Mode</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 140px;">Date</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 200px;">Service Start</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 200px;">Service End</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 200px;">Delivery</th>
            <th
              class="px-6 py-4 text-left text-xs font-semibold text-white uppercase border-b-2 border-blue-950 whitespace-nowrap"
              style="min-width: 100px;">Action</th>
          </tr>
        </thead>

        <tbody id="bookedGrid" class="divide-y divide-gray-200 bg-white"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="emptyState" class="hidden text-center py-16 bg-white rounded-lg mt-4 max-w-7xl mx-auto shadow-sm">
      <div class="text-6xl mb-4">ðŸ“‹</div>
      <h3 class="text-xl font-semibold text-gray-700 mb-2">No bookings found</h3>
      <p class="text-gray-500">New bookings will appear here</p>
    </div>

  </main>

  <!-- JavaScript -->
  <script>
    let booked = [];
    let staffList = [];

    // ---------------------------
    // LOAD STAFF (FIXED)
    // ---------------------------
    async function loadStaff() {
      try {
        const staffRes = await fetch("/admin/getstaff");
        const staffData = await staffRes.json();

        console.log("Staff API:", staffData);

        // FIX: extract array correctly
        staffList = staffData.Success?.data || [];

      } catch (err) {
        console.error("Error loading staff:", err);
      }
    }

    // Get staff name by ID
    function getStaffName(staffId) {
      const staff = staffList.find(s => s.ID == staffId);
      return staff ? `${staff.firstname} ${staff.lastname}` : "Unknown";
    }

    // ---------------------------
    // LOAD BOOKINGS (FIXED)
    // ---------------------------
    async function loadBooked() {
      try {
        const res = await fetch("/admin/getbooked");
        const data = await res.json();

        console.log("Bookings API:", data);

        // FIX: correct extraction
        booked = data.Success?.data || [];

        document.getElementById("totalCount").textContent = booked.length;

        const grid = document.getElementById("bookedGrid");
        grid.innerHTML = "";

        if (booked.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          return;
        }

        document.getElementById("emptyState").classList.add("hidden");

        let staffOptions = staffList
          .map(s => `<option value="${s.ID}">${s.firstname} ${s.lastname}</option>`)
          .join("");

        booked.forEach(b => {
          const hasStaff = b.staff_id;
          const staffName = hasStaff ? getStaffName(b.staff_id) : "";

          const staffCell = hasStaff
            ? `
              <div id="staff-display-${b.id}" class="flex items-center gap-2">
                <div class="bg-blue-50 border border-blue-200 rounded-lg px-3 py-2 text-sm text-blue-900 font-medium flex-1">
                  ðŸ‘¤ ${staffName} (ID: ${b.staff_id})
                </div>
                <button class="bg-orange-500 text-white px-3 py-2 rounded-lg text-sm hover:bg-orange-600" onclick="changeStaff('${b.id}')">Change</button>
              </div>
              <div id="staff-edit-${b.id}" class="hidden flex items-center gap-2">
                <select id="staff-${b.id}" class="border px-3 py-2 rounded-lg flex-1">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-500 text-white px-3 py-2 rounded-lg text-sm" onclick="assignBooking('${b.id}')">Assign</button>
                <button class="bg-gray-500 text-white px-3 py-2 rounded-lg text-sm" onclick="cancelChange('${b.id}')">Cancel</button>
              </div>
            `
            : `
              <div class="flex items-center gap-2">
                <select id="staff-${b.id}" class="border px-3 py-2 rounded-lg flex-1">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-500 text-white px-4 py-2 rounded-lg text-sm" onclick="assignBooking('${b.id}')">Assign</button>
              </div>
            `;

          grid.innerHTML += `
          <tr id="row-${b.id}">
            <td class="px-6 py-3">${b.car_number}</td>

            <td class="px-6 py-3">
              <select id="status-${b.id}" class="border rounded-lg px-3 py-2">
                <option ${b.status === "pending" ? "selected" : ""}>pending</option>
                <option ${b.status === "in-progress" ? "selected" : ""}>in-progress</option>
                <option ${b.status === "completed" ? "selected" : ""}>completed</option>
                <option ${b.status === "cancelled" ? "selected" : ""}>cancelled</option>
                <option ${b.status === "Assigned" ? "selected" : ""}>Assigned</option>
              </select>
            </td>

            <td class="px-6 py-3">
              <input id="problem-${b.id}" value="${b.problem}" class="border px-3 py-2 rounded-lg">
            </td>

            <td class="px-6 py-3">${b.address}</td>

            <td class="px-6 py-3">${staffCell}</td>

            <td class="px-6 py-3">
              <select id="paystat-${b.id}" class="border rounded-lg px-3 py-2">
                <option ${b.payment_status === "paid" ? "selected" : ""}>paid</option>
                <option ${b.payment_status !== "paid" ? "selected" : ""}>unpaid</option>
              </select>
            </td>

            <td class="px-6 py-3">
              <input type="number" id="amount-${b.id}" class="border rounded-lg px-3 py-2" value="${b.payment_amount}">
            </td>

            <td class="px-6 py-3">
              <select id="mode-${b.id}" class="border rounded-lg px-3 py-2">
                <option ${b.payment_mode === "cash" ? "selected" : ""}>cash</option>
                <option ${b.payment_mode === "upi" ? "selected" : ""}>upi</option>
                <option ${b.payment_mode === "card" ? "selected" : ""}>card</option>
              </select>
            </td>

            <td class="px-6 py-3">${b.date}</td>

            <td class="px-6 py-3">
              <input type="datetime-local" id="start-${b.id}" value="${b.service_start || ""}" class="border rounded-lg px-3 py-2">
            </td>

            <td class="px-6 py-3">
              <input type="datetime-local" id="end-${b.id}" value="${b.service_end || ""}" class="border rounded-lg px-3 py-2">
            </td>

            <td class="px-6 py-3">
              <input type="datetime-local" id="delivery-${b.id}" value="${b.delivery || ""}" class="border rounded-lg px-3 py-2">
            </td>

            <td class="px-6 py-3">
              <button class="bg-blue-600 text-white px-4 py-2 rounded-lg" onclick="saveRow('${b.id}')">Save</button>
            </td>
          </tr>
        `;
        });

      } catch (err) {
        console.error("Failed to load booked services:", err);
      }
    }

    // Show edit options
    function changeStaff(id) {
      document.getElementById(`staff-display-${id}`).classList.add("hidden");
      document.getElementById(`staff-edit-${id}`).classList.remove("hidden");
    }

    function cancelChange(id) {
      document.getElementById(`staff-display-${id}`).classList.remove("hidden");
      document.getElementById(`staff-edit-${id}`).classList.add("hidden");
    }

    // Assign staff
    async function assignBooking(id) {
      const staffId = document.getElementById(`staff-${id}`).value;

      if (!staffId) return alert("Select a staff first!");

      try {
        const response = await fetch(`/admin/assignstaff/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ staff_id: staffId })
        });

        const data = await response.json();
        console.log("Assign Resp:", data);

        alert("Assigned successfully!");
        loadBooked();

      } catch (err) {
        console.error("Error assigning staff:", err);
        alert("Failed to assign staff");
      }
    }

    // Save row update
    async function saveRow(id) {
      const payload = {
        status: document.getElementById(`status-${id}`).value,
        payment_status: document.getElementById(`paystat-${id}`).value,
        payment_amount: parseFloat(document.getElementById(`amount-${id}`).value) || 0,
        payment_mode: document.getElementById(`mode-${id}`).value,
        service_start: document.getElementById(`start-${id}`).value || null,
        service_end: document.getElementById(`end-${id}`).value || null,
        delivery: document.getElementById(`delivery-${id}`).value || null,
        problem: document.getElementById(`problem-${id}`).value
      };

      try {
        await fetch(`/admin/update/booked//${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alert("Updated Successfully!");
        loadBooked();

      } catch (err) {
        console.error("Error updating booking:", err);
        alert("Failed to update booking");
      }
    }

    // INIT
    (async () => {
      await loadStaff();
      await loadBooked();
    })();

  </script>


</body>

</html>