<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Booked Services Dashboard</title>
  <style>
    .scrollbar-thin::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }

    .locked-row {
      opacity: 0.7;
      background-color: #f9fafb !important;
    }

    .locked-badge {
      position: relative;
    }

    .locked-badge::after {
      content: 'üîí';
      position: absolute;
      top: -4px;
      right: -4px;
      font-size: 14px;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex">
  <!-- Sidebar -->
  {{ template "sidebar" }}

  <!-- Main Section -->
  <main class="flex-1 px-6 py-6 overflow-auto">

    <!-- Header -->
    <div class="bg-white p-6 rounded-lg mb-6 shadow-sm max-w-7xl mx-auto border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-semibold text-gray-900 mb-1">Booked Services Dashboard</h1>
          <p class="text-gray-600 text-sm">Manage and track all service bookings</p>
        </div>

        <div class="flex gap-4">
          <div class="bg-blue-600 text-white px-6 py-4 rounded-lg shadow-sm min-w-[140px]">
            <div class="text-3xl font-bold mb-1" id="totalCount">0</div>
            <div class="text-sm opacity-90">Total Bookings</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div
      class="max-h-[600px] overflow-x-auto overflow-y-auto rounded-lg shadow-sm bg-white max-w-7xl mx-auto border border-gray-200 scrollbar-thin">
      <table class="w-full border-separate border-spacing-0" style="min-width: 2200px;">
        <thead class="sticky top-0 z-10">
          <tr class="bg-gray-800">
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Car Number
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Status
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 250px;">
              Message
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 200px;">
              Description
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Address
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 280px;">
              Staff Assignment
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Payment
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Amount
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 110px;">
              Mode
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 110px;">
              Date
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Delivery
            </th>
            <th
              class="px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 100px;">
              Slot
            </th>
            <th
              class="px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 90px;">
              Action
            </th>
          </tr>
        </thead>

        <tbody id="bookedGrid" class="divide-y divide-gray-200 bg-white"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="emptyState"
      class="hidden text-center py-16 bg-white rounded-lg mt-4 max-w-7xl mx-auto shadow-sm border border-gray-200">
      <div class="text-6xl mb-4">üìã</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">No bookings found</h3>
      <p class="text-gray-500">New bookings will appear here</p>
    </div>

  </main>

  <!-- JavaScript -->
  <script>
    let booked = [];
    let staffList = [];
    let slotCount = 0;
    const MAX_SLOTS = 5;

    // Define locked statuses
    const LOCKED_STATUSES = ['REJECTED', 'DELIVERED'];

    const statusColors = {
      'UNAVAILABLE': 'bg-red-100 text-red-800 border-2 border-red-500',
      'PENDING': 'bg-amber-100 text-amber-800 border-2 border-amber-500',
      'COMPLETED': 'bg-green-100 text-green-800 border-2 border-green-500',
      'APPROVED': 'bg-blue-100 text-blue-800 border-2 border-blue-500',
      'ASSIGNEDSLOT': 'bg-purple-100 text-purple-800 border-2 border-purple-500',
      'ACCEPTED': 'bg-emerald-100 text-emerald-800 border-2 border-emerald-500',
      'REJECTED': 'bg-red-200 text-red-900 border-2 border-red-600',
      'SERVICE STARTED': 'bg-cyan-100 text-cyan-800 border-2 border-cyan-500',
      'SERVICE ENDED': 'bg-teal-100 text-teal-800 border-2 border-teal-500',
      'DELIVERED': 'bg-green-200 text-green-900 border-2 border-green-600',
      'WAITING': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-500'
    };

    function isLocked(status) {
      return LOCKED_STATUSES.includes(status);
    }

    function getStatusBadge(status, locked = false) {
      const colors = statusColors[status] || 'bg-gray-100 text-gray-800 border-2 border-gray-500';
      const lockedClass = locked ? 'locked-badge' : '';
      return `
        <div class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide ${colors} shadow-sm min-w-[140px] ${lockedClass}">
          ${status}
        </div>
      `;
    }

    async function loadStaff() {
      try {
        const staffRes = await fetch("/admin/getstaff");
        const staffData = await staffRes.json();
        console.log("Staff API:", staffData);
        staffList = staffData.Success?.data || [];
      } catch (err) {
        console.error("Error loading staff:", err);
      }
    }

    function getStaffName(staffId) {
      const staff = staffList.find(s => s.ID == staffId);
      return staff ? `${staff.firstname} ${staff.lastname}` : "Unknown";
    }

    async function getSlotCount() {
      try {
        const res = await fetch("/admin/getslots");
        const data = await res.json();

        if (data.Success && typeof data.Success.data === 'number') {
          slotCount = data.Success.data;
        } else {
          slotCount = 0;
        }
      } catch (err) {
        console.error("Error loading slot count:", err);
        slotCount = 0;
      }
    }

    function handleMessageChange(id) {
      const booking = booked.find(b => b.id == id);
      if (booking && isLocked(booking.status)) {
        alert("üîí This booking is locked and cannot be modified.");
        return;
      }

      const select = document.getElementById(`message-select-${id}`);
      const input = document.getElementById(`message-${id}`);
      const statusSelect = document.getElementById(`status-${id}`);
      const selectedValue = select.value;

      if (selectedValue === "CUSTOM") {
        input.focus();
        select.value = "";
      } else if (selectedValue) {
        input.value = selectedValue;
        
        // Auto-update status based on message selection
        const messageToStatusMap = {
          'Your request has been approved. Our team will contact you soon.': 'APPROVED',
          'Your booking has been accepted. Stay tuned, our crew is on it!': 'ACCEPTED',
          'Your request has been rejected. Please review and try again.': 'REJECTED',
          'Your request is pending. Our team will update you shortly.': 'PENDING',
          'This service is currently unavailable. Please try again later.': 'UNAVAILABLE',
          'The process is completed. Thank you for your patience!': 'COMPLETED',
          'A slot has been assigned for your service. Our team will keep you updated.': 'ASSIGNEDSLOT',
          'Service has started ‚Äî your vehicle is now being worked on.': 'SERVICE STARTED',
          'Service is completed! Our team will contact you for the next steps.': 'SERVICE ENDED',
          'Your vehicle/service has been delivered. Thank you for choosing us!': 'DELIVERED',
          'Your request is in the queue. Our team will connect with you soon.': 'WAITING'
        };

        const matchedStatus = messageToStatusMap[selectedValue];
        if (matchedStatus) {
          statusSelect.value = matchedStatus;
          updateStatusDisplay(id, matchedStatus);
        }
      }
    }

    async function loadBooked() {
      try {
        const res = await fetch("/admin/getbooked");
        const data = await res.json();
        console.log("Bookings API:", data);
        booked = data.Success?.data || [];

        document.getElementById("totalCount").textContent = booked.length;

        const grid = document.getElementById("bookedGrid");
        grid.innerHTML = "";

        if (booked.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          return;
        }

        document.getElementById("emptyState").classList.add("hidden");

        let staffOptions = staffList
          .map(s => `<option value="${s.ID}">${s.firstname} ${s.lastname}</option>`)
          .join("");

        booked.forEach(b => {
          const locked = isLocked(b.status);
          const hasStaff = b.staff_id;
          const staffName = hasStaff ? getStaffName(b.staff_id) : "";
          const isSlotted = b.slot_id != null && b.slot_id != undefined;
          const disabledAttr = locked ? 'disabled' : '';
          const lockedRowClass = locked ? 'locked-row' : '';

          // Staff assignment cell
          const staffCell = locked 
            ? `
              <div class="bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-500 font-medium">
                ${hasStaff ? `üë§ ${staffName} (ID: ${b.staff_id})` : 'No Assignment'}
                <span class="ml-2">üîí</span>
              </div>
            `
            : hasStaff
            ? `
              <div id="staff-display-${b.id}" class="flex items-center gap-2">
                <div class="bg-blue-50 border border-blue-200 rounded-md px-3 py-2 text-sm text-blue-900 font-medium flex-1">
                  üë§ ${staffName} (ID: ${b.staff_id})
                </div>
                <button class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="changeStaff('${b.id}')">
                  Change
                </button>
              </div>
              <div id="staff-edit-${b.id}" class="hidden flex items-center gap-2">
                <select id="staff-${b.id}" class="border border-gray-300 px-3 py-2 rounded-md flex-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="assignBooking('${b.id}')">
                  Assign
                </button>
                <button class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="cancelChange('${b.id}')">
                  Cancel
                </button>
              </div>
            `
            : `
              <div class="flex items-center gap-2">
                <select id="staff-${b.id}" class="border border-gray-300 px-3 py-2 rounded-md flex-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="assignBooking('${b.id}')">
                  Assign
                </button>
              </div>
            `;

          // Slot cell
          const slotCell = locked
            ? `<div class="bg-gray-100 border border-gray-300 rounded-md px-3 py-2 text-sm text-gray-500 font-medium text-center">
                ${isSlotted ? '‚úì Slotted' : 'N/A'} üîí
              </div>`
            : isSlotted 
            ? `<div class="bg-gradient-to-r from-purple-100 to-purple-200 text-purple-800 px-4 py-2 rounded-lg text-sm font-bold border-2 border-purple-400 shadow-md">
                ‚úì Slotted
              </div>`
            : `<button 
                id="slot-btn-${b.id}"
                onclick="addToSlot('${b.id}')"
                class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-semibold transition-all shadow hover:shadow-lg">
                + Add to Slot
              </button>`;

          // Action button
          const actionButton = locked
            ? `<div class="bg-gray-300 text-gray-500 px-3 py-1.5 rounded-md text-sm font-medium cursor-not-allowed" title="This booking is locked">
                üîí Locked
              </div>`
            : `<button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors" onclick="saveRow('${b.id}')">
                Save
              </button>`;

          grid.innerHTML += `
          <tr id="row-${b.id}" class="hover:bg-gray-50 transition-colors ${lockedRowClass}">
            <td class="px-4 py-3">
              <span class="font-semibold text-gray-900">${b.car_number}</span>
            </td>

            <td class="px-4 py-3">
              <div id="status-display-${b.id}" onclick="${locked ? '' : `editStatus('${b.id}')`}" class="${locked ? '' : 'cursor-pointer'}">
                ${getStatusBadge(b.status || 'PENDING', locked)}
              </div>
              <select id="status-${b.id}" class="hidden border-2 border-gray-300 rounded-md px-3 py-1.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full" onchange="updateStatusDisplay('${b.id}', this.value)" ${disabledAttr}>
                <option value="UNAVAILABLE" ${b.status === "UNAVAILABLE" ? "selected" : ""}>UNAVAILABLE</option>
                <option value="PENDING" ${b.status === "PENDING" ? "selected" : ""}>PENDING</option>
                <option value="COMPLETED" ${b.status === "COMPLETED" ? "selected" : ""}>COMPLETED</option>
                <option value="APPROVED" ${b.status === "APPROVED" ? "selected" : ""}>APPROVED</option>
                <option value="ASSIGNEDSLOT" ${b.status === "ASSIGNEDSLOT" ? "selected" : ""}>ASSIGNED SLOT</option>
                <option value="ACCEPTED" ${b.status === "ACCEPTED" ? "selected" : ""}>ACCEPTED</option>
                <option value="REJECTED" ${b.status === "REJECTED" ? "selected" : ""}>REJECTED</option>
                <option value="SERVICE STARTED" ${b.status === "SERVICE STARTED" ? "selected" : ""}>SERVICE STARTED</option>
                <option value="SERVICE ENDED" ${b.status === "SERVICE ENDED" ? "selected" : ""}>SERVICE ENDED</option>
                <option value="DELIVERED" ${b.status === "DELIVERED" ? "selected" : ""}>DELIVERED</option>
                <option value="WAITING" ${b.status === "WAITING" ? "selected" : ""}>WAITING</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <div class="flex flex-col gap-2">
                <select id="message-select-${b.id}" class="border border-gray-300 px-3 py-1.5 rounded-md w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" onchange="handleMessageChange('${b.id}')" ${disabledAttr}>
                  <option value="">-- Select Message --</option>
                  <option value="CUSTOM">‚úçÔ∏è Write Custom Message</option>
                  <option value="Your request has been approved. Our team will contact you soon.">Approved Message</option>
                  <option value="Your booking has been accepted. Stay tuned, our crew is on it!">Accepted Message</option>
                  <option value="Your request has been rejected. Please review and try again.">Rejected Message</option>
                  <option value="Your request is pending. Our team will update you shortly.">Pending Message</option>
                  <option value="This service is currently unavailable. Please try again later.">Unavailable Message</option>
                  <option value="The process is completed. Thank you for your patience!">Completed Message</option>
                  <option value="A slot has been assigned for your service. Our team will keep you updated.">Assigned Slot Message</option>
                  <option value="Service has started ‚Äî your vehicle is now being worked on.">Service Started Message</option>
                  <option value="Service is completed! Our team will contact you for the next steps.">Service Ended Message</option>
                  <option value="Your vehicle/service has been delivered. Thank you for choosing us!">Delivered Message</option>
                  <option value="Your request is in the queue. Our team will connect with you soon.">Waiting Message</option>
                  <option value="Request accepted you can see more details on booked">Accept/Assigned Booking</option>
                </select>
                <input id="message-${b.id}" value="${b.message || ''}" placeholder="Type custom message here..." class="border border-gray-300 px-3 py-1.5 rounded-md w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" ${disabledAttr}>
              </div>
            </td>
            
            <td class="px-4 py-3">
              <input id="description-${b.id}" value="${b.description}" class="border border-gray-300 px-3 py-1.5 rounded-md w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" ${disabledAttr}>
            </td>

            <td class="px-4 py-3">
              <span class="text-gray-700 text-sm">${b.address}</span>
            </td>

            <td class="px-4 py-3">${staffCell}</td>

            <td class="px-4 py-3">
              <select id="paystat-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full" ${disabledAttr}>
                <option ${b.payment_status === "paid" ? "selected" : ""}>paid</option>
                <option ${b.payment_status !== "paid" ? "selected" : ""}>unpaid</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <input type="number" id="amount-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="${b.payment_amount}" ${disabledAttr}>
            </td>

            <td class="px-4 py-3">
              <select id="mode-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full" ${disabledAttr}>
                <option ${b.payment_mode === "cash" ? "selected" : ""}>cash</option>
                <option ${b.payment_mode === "upi" ? "selected" : ""}>upi</option>
                <option ${b.payment_mode === "card" ? "selected" : ""}>card</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <span class="text-gray-700 text-sm">${b.date}</span>
            </td>
            
            <td class="px-4 py-3">
              <input type="datetime-local" id="delivery-${b.id}" value="${b.delivery || ""}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full" ${disabledAttr}>
            </td>
  
            <td class="px-4 py-3 text-center">
              <div class="flex flex-col items-center gap-2"> 
                ${slotCell}
              </div>
            </td>

            <td class="px-4 py-3 text-center">
              ${actionButton}
            </td>
          </tr>
        `;
        });

      } catch (err) {
        console.error("Failed to load booked services:", err);
      }
    }

    function editStatus(id) {
      document.getElementById(`status-display-${id}`).classList.add('hidden');
      document.getElementById(`status-${id}`).classList.remove('hidden');
      document.getElementById(`status-${id}`).focus();
    }

    function updateStatusDisplay(id, status) {
      document.getElementById(`status-display-${id}`).innerHTML = getStatusBadge(status);
      document.getElementById(`status-display-${id}`).classList.remove('hidden');
      document.getElementById(`status-${id}`).classList.add('hidden');

      const booking = booked.find(b => b.id == id);
      if (booking) {
        booking.status = status;
      }

      // Auto-fill message based on status
      autoFillMessageByStatus(id, status);
    }

    function autoFillMessageByStatus(id, status) {
      const messageInput = document.getElementById(`message-${id}`);
      const messageSelect = document.getElementById(`message-select-${id}`);
      
      const statusMessageMap = {
        'APPROVED': 'Your request has been approved. Our team will contact you soon.',
        'ACCEPTED': 'Your booking has been accepted. Stay tuned, our crew is on it!',
        'REJECTED': 'Your request has been rejected. Please review and try again.',
        'PENDING': 'Your request is pending. Our team will update you shortly.',
        'UNAVAILABLE': 'This service is currently unavailable. Please try again later.',
        'COMPLETED': 'The process is completed. Thank you for your patience!',
        'ASSIGNEDSLOT': 'A slot has been assigned for your service. Our team will keep you updated.',
        'SERVICE STARTED': 'Service has started ‚Äî your vehicle is now being worked on.',
        'SERVICE ENDED': 'Service is completed! Our team will contact you for the next steps.',
        'DELIVERED': 'Your vehicle/service has been delivered. Thank you for choosing us!',
        'WAITING': 'Your request is in the queue. Our team will connect with you soon.'
      };

      if (statusMessageMap[status]) {
        messageInput.value = statusMessageMap[status];
        messageSelect.value = statusMessageMap[status];
      }
    }

    function changeStaff(id) {
      document.getElementById(`staff-display-${id}`).classList.add("hidden");
      document.getElementById(`staff-edit-${id}`).classList.remove("hidden");
    }

    function cancelChange(id) {
      document.getElementById(`staff-display-${id}`).classList.remove("hidden");
      document.getElementById(`staff-edit-${id}`).classList.add("hidden");
    }

    async function assignBooking(id) {
      const staffId = document.getElementById(`staff-${id}`).value;

      if (!staffId) {
        alert("‚ö†Ô∏è Please select a staff member first!");
        return;
      }

      try {
        const response = await fetch(`/admin/assignstaff/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ staff_id: staffId })
        });

        const data = await response.json();
        console.log("Assign Response:", data);

        if (!response.ok || data.Error || data.error) {
          alert(`‚ùå Failed to assign staff: ${data.Error || data.error || 'Unknown error'}`);
          return;
        }

        alert("‚úÖ Staff assigned successfully!");
        await loadBooked();

      } catch (err) {
        console.error("Error assigning staff:", err);
        alert("‚ùå Failed to assign staff. Please try again.");
      }
    }

    async function addToSlot(id) {
      const booking = booked.find(b => b.id == id);

      if (!booking || !booking.staff_id) {
        alert("‚ö†Ô∏è Please assign a staff member before adding to slot!");
        return;
      }

      if (booking.slot_id) {
        alert("‚ÑπÔ∏è This booking is already in a slot!");
        return;
      }

      try {
        const res = await fetch(`/admin/addslot/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        console.log("Slot Response:", data);

        if (!res.ok || data.error) {
          const errorMsg = data.error?.message || data.error || 'Unknown error';

          if (errorMsg.toLowerCase().includes("slot are full")) {
            alert(`üîí SLOTS ARE FULL!\nAll ${MAX_SLOTS} slots are currently occupied.`);
          } else if (errorMsg.toLowerCase().includes("already on the slot")) {
            alert("‚ÑπÔ∏è This booking is already in a slot!");
          } else if (errorMsg.toLowerCase().includes("select the staff")) {
            alert("‚ö†Ô∏è Please assign a staff member before adding to slot!");
          } else {
            alert(`‚ùå Failed to add to slot: ${errorMsg}`);
          }

          return;
        }

        alert("‚úÖ Added to slot successfully!");
        await getSlotCount();
        await loadBooked();

      } catch (err) {
        console.error("Error adding to slot:", err);
        alert("‚ùå Failed to add to slot. Please try again.");
      }
    }

    async function saveRow(id) {
      const payload = {
        status: document.getElementById(`status-${id}`).value,
        message: document.getElementById(`message-${id}`).value,
        description: document.getElementById(`description-${id}`).value,
        payment_status: document.getElementById(`paystat-${id}`).value,
        payment_amount: parseFloat(document.getElementById(`amount-${id}`).value) || 0,
        payment_mode: document.getElementById(`mode-${id}`).value,
        delivery: document.getElementById(`delivery-${id}`).value || null
      };

      try {
        const response = await fetch(`/admin/update/booked/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        const data = await response.json();

        if (!response.ok || data.error) {
          alert(`‚ùå Failed to update: ${data.error?.message || data.error || 'Unknown error'}`);
          return;
        }

        alert("‚úÖ Updated successfully!");
        await loadBooked();

      } catch (err) {
        console.error("Error updating booking:", err);
        alert("‚ùå Failed to update booking. Please try again.");
      }
    }

    (async () => {
      await loadStaff();
      await getSlotCount();
      await loadBooked();
      console.log(`üìä Slots Status: ${slotCount}/${MAX_SLOTS} used`);
    })();

  </script>

</body>

</html>