<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <title>Booked Services Dashboard</title>
  <style>
    .scrollbar-thin::-webkit-scrollbar {
      width: 8px;
      height: 8px;
    }

    .scrollbar-thin::-webkit-scrollbar-track {
      background: #f1f5f9;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb {
      background: #cbd5e1;
      border-radius: 4px;
    }

    .scrollbar-thin::-webkit-scrollbar-thumb:hover {
      background: #94a3b8;
    }
  </style>
</head>

<body class="bg-gray-50 min-h-screen flex">
  <!-- Sidebar -->
  {{ template "sidebar" }}

  <!-- Main Section -->
  <main class="flex-1 px-6 py-6 overflow-auto">

    <!-- Header -->
    <div class="bg-white p-6 rounded-lg mb-6 shadow-sm max-w-7xl mx-auto border border-gray-200">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-semibold text-gray-900 mb-1">Booked Services Dashboard</h1>
          <p class="text-gray-600 text-sm">Manage and track all service bookings</p>
        </div>

        <div class="bg-blue-600 text-white px-6 py-4 rounded-lg shadow-sm min-w-[140px]">
          <div class="text-3xl font-bold mb-1" id="totalCount">0</div>
          <div class="text-sm opacity-90">Total Bookings</div>
        </div>
      </div>
    </div>

    <!-- Table Container -->
    <div
      class="max-h-[600px] overflow-x-auto overflow-y-auto rounded-lg shadow-sm bg-white max-w-7xl mx-auto border border-gray-200 scrollbar-thin">
      <table class="w-full border-separate border-spacing-0" style="min-width: 2200px;">
        <thead class="sticky top-0 z-10">
          <tr class="bg-gray-800">
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Car Number
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Status
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 200px;">
              Message
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 200px;">
              Description
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Address
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 280px;">
              Staff Assignment
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Payment
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 120px;">
              Amount
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 110px;">
              Mode
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 110px;">
              Date
            </th>
            <th
              class="px-4 py-3 text-left text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 180px;">
              Delivery
            </th>
            <th
              class="px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 100px;">
              Slot
            </th>
            <th
              class="px-4 py-3 text-center text-xs font-semibold text-white uppercase tracking-wide border-b border-gray-700 whitespace-nowrap"
              style="min-width: 90px;">
              Action
            </th>
          </tr>
        </thead>

        <tbody id="bookedGrid" class="divide-y divide-gray-200 bg-white"></tbody>
      </table>
    </div>

    <!-- Empty State -->
    <div id="emptyState"
      class="hidden text-center py-16 bg-white rounded-lg mt-4 max-w-7xl mx-auto shadow-sm border border-gray-200">
      <div class="text-6xl mb-4">ðŸ“‹</div>
      <h3 class="text-xl font-semibold text-gray-800 mb-2">No bookings found</h3>
      <p class="text-gray-500">New bookings will appear here</p>
    </div>

  </main>

  <!-- JavaScript -->
  <script>
    let booked = [];
    let staffList = [];

    // Status color mapping
    const statusColors = {
      'UNAVAILABLE': 'bg-red-100 text-red-800 border-2 border-red-500',
      'PENDING': 'bg-amber-100 text-amber-800 border-2 border-amber-500',
      'COMPLETED': 'bg-green-100 text-green-800 border-2 border-green-500',
      'APPROVED': 'bg-blue-100 text-blue-800 border-2 border-blue-500',
      'ASSIGNEDSLOT': 'bg-purple-100 text-purple-800 border-2 border-purple-500',
      'ACCEPTED': 'bg-emerald-100 text-emerald-800 border-2 border-emerald-500',
      'REJECTED': 'bg-red-200 text-red-900 border-2 border-red-600',
      'SERVICE STARTED': 'bg-cyan-100 text-cyan-800 border-2 border-cyan-500',
      'SERVICE ENDED': 'bg-teal-100 text-teal-800 border-2 border-teal-500',
      'DELIVERED': 'bg-green-200 text-green-900 border-2 border-green-600',
      'WAITING': 'bg-yellow-100 text-yellow-800 border-2 border-yellow-500'
    };

    // Get status badge HTML
    function getStatusBadge(status) {
      const colors = statusColors[status] || 'bg-gray-100 text-gray-800 border-2 border-gray-500';
      return `
        <div class="inline-flex items-center justify-center px-3 py-2 rounded-lg text-xs font-bold uppercase tracking-wide ${colors} shadow-sm min-w-[140px]">
          ${status}
        </div>
      `;
    }

    // ---------------------------
    // LOAD STAFF
    // ---------------------------
    async function loadStaff() {
      try {
        const staffRes = await fetch("/admin/getstaff");
        const staffData = await staffRes.json();
        console.log("Staff API:", staffData);
        staffList = staffData.Success?.data || [];
      } catch (err) {
        console.error("Error loading staff:", err);
      }
    }

    // Get staff name by ID
    function getStaffName(staffId) {
      const staff = staffList.find(s => s.ID == staffId);
      return staff ? `${staff.firstname} ${staff.lastname}` : "Unknown";
    }

    // ---------------------------
    // LOAD BOOKINGS
    // ---------------------------
    async function loadBooked() {
      try {
        const res = await fetch("/admin/getbooked");
        const data = await res.json();
        console.log("Bookings API:", data);
        booked = data.Success?.data || [];

        document.getElementById("totalCount").textContent = booked.length;

        const grid = document.getElementById("bookedGrid");
        grid.innerHTML = "";

        if (booked.length === 0) {
          document.getElementById("emptyState").classList.remove("hidden");
          return;
        }

        document.getElementById("emptyState").classList.add("hidden");

        let staffOptions = staffList
          .map(s => `<option value="${s.ID}">${s.firstname} ${s.lastname}</option>`)
          .join("");

        booked.forEach(b => {
          const hasStaff = b.staff_id;
          const staffName = hasStaff ? getStaffName(b.staff_id) : "";

          const staffCell = hasStaff
            ? `
              <div id="staff-display-${b.id}" class="flex items-center gap-2">
                <div class="bg-blue-50 border border-blue-200 rounded-md px-3 py-2 text-sm text-blue-900 font-medium flex-1">
                  ðŸ‘¤ ${staffName} (ID: ${b.staff_id})
                </div>
                <button class="bg-orange-500 hover:bg-orange-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="changeStaff('${b.id}')">
                  Change
                </button>
              </div>
              <div id="staff-edit-${b.id}" class="hidden flex items-center gap-2">
                <select id="staff-${b.id}" class="border border-gray-300 px-3 py-2 rounded-md flex-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="assignBooking('${b.id}')">
                  Assign
                </button>
                <button class="bg-gray-500 hover:bg-gray-600 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="cancelChange('${b.id}')">
                  Cancel
                </button>
              </div>
            `
            : `
              <div class="flex items-center gap-2">
                <select id="staff-${b.id}" class="border border-gray-300 px-3 py-2 rounded-md flex-1 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
                  <option value="">Select Worker</option>
                  ${staffOptions}
                </select>
                <button class="bg-green-600 hover:bg-green-700 text-white px-3 py-2 rounded-md text-sm font-medium transition-colors" onclick="assignBooking('${b.id}')">
                  Assign
                </button>
              </div>
            `;

          grid.innerHTML += `
          <tr id="row-${b.id}" class="hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3">
              <span class="font-semibold text-gray-900">${b.car_number}</span>
            </td>

            <td class="px-4 py-3">
              <div id="status-display-${b.id}" onclick="editStatus('${b.id}')" class="cursor-pointer">
                ${getStatusBadge(b.status || 'PENDING')}
              </div>
              <select id="status-${b.id}" class="hidden border-2 border-gray-300 rounded-md px-3 py-1.5 text-sm font-medium focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full" onchange="updateStatusDisplay('${b.id}', this.value)">
                <option value="UNAVAILABLE" ${b.status === "UNAVAILABLE" ? "selected" : ""}>UNAVAILABLE</option>
                <option value="PENDING" ${b.status === "PENDING" ? "selected" : ""}>PENDING</option>
                <option value="COMPLETED" ${b.status === "COMPLETED" ? "selected" : ""}>COMPLETED</option>
                <option value="APPROVED" ${b.status === "APPROVED" ? "selected" : ""}>APPROVED</option>
                <option value="ASSIGNEDSLOT" ${b.status === "ASSIGNEDSLOT" ? "selected" : ""}>ASSIGNED SLOT</option>
                <option value="ACCEPTED" ${b.status === "ACCEPTED" ? "selected" : ""}>ACCEPTED</option>
                <option value="REJECTED" ${b.status === "REJECTED" ? "selected" : ""}>REJECTED</option>
                <option value="SERVICE STARTED" ${b.status === "SERVICE STARTED" ? "selected" : ""}>SERVICE STARTED</option>
                <option value="SERVICE ENDED" ${b.status === "SERVICE ENDED" ? "selected" : ""}>SERVICE ENDED</option>
                <option value="DELIVERED" ${b.status === "DELIVERED" ? "selected" : ""}>DELIVERED</option>
                <option value="WAITING" ${b.status === "WAITING" ? "selected" : ""}>WAITING</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <input id="message-${b.id}" value="${b.message || ''}" class="border border-gray-300 px-3 py-1.5 rounded-md w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </td>
            
            <td class="px-4 py-3">
              <input id="description-${b.id}" value="${b.description}" class="border border-gray-300 px-3 py-1.5 rounded-md w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent">
            </td>

            <td class="px-4 py-3">
              <span class="text-gray-700 text-sm">${b.address}</span>
            </td>

            <td class="px-4 py-3">${staffCell}</td>

            <td class="px-4 py-3">
              <select id="paystat-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full">
                <option ${b.payment_status === "paid" ? "selected" : ""}>paid</option>
                <option ${b.payment_status !== "paid" ? "selected" : ""}>unpaid</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <input type="number" id="amount-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 w-full text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent" value="${b.payment_amount}">
            </td>

            <td class="px-4 py-3">
              <select id="mode-${b.id}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-white w-full">
                <option ${b.payment_mode === "cash" ? "selected" : ""}>cash</option>
                <option ${b.payment_mode === "upi" ? "selected" : ""}>upi</option>
                <option ${b.payment_mode === "card" ? "selected" : ""}>card</option>
              </select>
            </td>

            <td class="px-4 py-3">
              <span class="text-gray-700 text-sm">${b.date}</span>
            </td>
            
            <td class="px-4 py-3">
              <input type="datetime-local" id="delivery-${b.id}" value="${b.delivery || ""}" class="border border-gray-300 rounded-md px-3 py-1.5 text-sm focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent w-full">
            </td>
  
         <td class="px-4 py-3 text-center">
       <div class="flex flex-col items-center gap-1"> 
        <div id="slot-label-${b.id}" 
         class="hidden bg-purple-100 text-purple-700 px-3 py-1 rounded-md text-xs font-semibold border border-purple-300 shadow">
        Slotted âœ”
       </div>
      <button 
      id="slot-btn-${b.id}"
      onclick="addToSlot('${b.id}')"
      class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors">
      Add to Slot
       </button>
      </div>
          </td>
            <td class="px-4 py-3 text-center">
              <button class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1.5 rounded-md text-sm font-medium transition-colors" onclick="saveRow('${b.id}')">
                Save
              </button>
            </td>
          </tr>
        `;
        });

      } catch (err) {
        console.error("Failed to load booked services:", err);
      }
    }

    // Status change functions
    function editStatus(id) {
      document.getElementById(`status-display-${id}`).classList.add('hidden');
      document.getElementById(`status-${id}`).classList.remove('hidden');
      document.getElementById(`status-${id}`).focus();
    }

    function updateStatusDisplay(id, status) {
      document.getElementById(`status-display-${id}`).innerHTML = getStatusBadge(status);
      document.getElementById(`status-display-${id}`).classList.remove('hidden');
      document.getElementById(`status-${id}`).classList.add('hidden');

      // Update the booking data
      const booking = booked.find(b => b.id == id);
      if (booking) {
        booking.status = status;
      }
    }

    // Show edit options
    function changeStaff(id) {
      document.getElementById(`staff-display-${id}`).classList.add("hidden");
      document.getElementById(`staff-edit-${id}`).classList.remove("hidden");
    }

    function cancelChange(id) {
      document.getElementById(`staff-display-${id}`).classList.remove("hidden");
      document.getElementById(`staff-edit-${id}`).classList.add("hidden");
    }

    // Assign staff
    async function assignBooking(id) {
      const staffId = document.getElementById(`staff-${id}`).value;

      if (!staffId) return alert("Select a staff first!");

      try {
        const response = await fetch(`/admin/assignstaff/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ staff_id: staffId })
        });

        const data = await response.json();
        console.log("Assign Resp:", data);

        alert("Assigned successfully!");
        loadBooked();

      } catch (err) {
        console.error("Error assigning staff:", err);
        alert("Failed to assign staff");
      }
    }


    async function addToSlot(id) {
      try {
        const res = await fetch(`/admin/addslot/${id}`, {
          method: "POST",
          headers: { "Content-Type": "application/json" }
        });

        const data = await res.json();
        console.log("Slot Assigned Resp:", data);

        if (!data.Success) {
          alert("Failed to add slot!");
          return;
        }

        // ðŸ”¥ Update UI instantly
        const btn = document.getElementById(`slot-btn-${id}`);
        const slotLabel = document.getElementById(`slot-label-${id}`);
        const statusDisplay = document.getElementById(`status-display-${id}`);

        // Show 'Slotted' label
        slotLabel.classList.remove("hidden");

        // Change button style & disable
        btn.disabled = true;
        btn.textContent = "Added";
        btn.classList.remove("bg-purple-600", "hover:bg-purple-700");
        btn.classList.add("bg-gray-400", "cursor-not-allowed");

        // Change status to ASSIGNEDSLOT
        statusDisplay.innerHTML = getStatusBadge("ASSIGNEDSLOT");

        // ðŸš€ Update count after slotting
        updateCount();

        alert("Added to slot successfully!");

      } catch (err) {
        console.error("Error adding to slot:", err);
        alert("Failed to add to slot!");
      }
    }

    // =============================
    // UPDATE BOOKING COUNT
    // =============================
    function updateCount() {
      document.getElementById("totalCount").textContent = booked.length;
    }

    // Save row update
    async function saveRow(id) {
      const payload = {
        status: document.getElementById(`status-${id}`).value,
        message: document.getElementById(`message-${id}`).value,
        description: document.getElementById(`description-${id}`).value,
        payment_status: document.getElementById(`paystat-${id}`).value,
        payment_amount: parseFloat(document.getElementById(`amount-${id}`).value) || 0,
        payment_mode: document.getElementById(`mode-${id}`).value,
        delivery: document.getElementById(`delivery-${id}`).value || null
      };

      try {
        await fetch(`/admin/update/booked/${id}`, {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(payload)
        });

        alert("Updated Successfully!");
        loadBooked();

      } catch (err) {
        console.error("Error updating booking:", err);
        alert("Failed to update booking");
      }
    }

    // INIT
    (async () => {
      await loadStaff();
      await loadBooked();
      updateCount();
    })();

  </script>

</body>

</html>